---
layout: post
title: 使用ssh连接到wsl和docker镜像
date: 2025-11-10 20:24 +0800
categories: [技术经验, 远程服务]
tags: [ssh, wsl, docker] # TAG 名称应始终为小写
---

无论是wsl还是docker容器（运行linux镜像），都是可以安装ssh-server来允许ssh远程访问。然而，由于wsl和docker的特殊性，它们无法跟正常的实体机一样，直接ssh访问。因此，本文将分别进行描述。

## 前置要求

首先，肯定都需要安装openssh-server的。但是，出于安全性考虑，建议都修改一下ssh的默认端口。  
```shell
sudo vim /etc/ssh/sshd_config
```
取消注释`Port 22`条目，并且修改为自己的默认端口。

此外，wsl需要选择`mirrored`网络，也就是与主机共享IP。docker启动容器需要添加`--net host`参数，同样是共享主机IP。否则，它们都会通过NAT构建在自己的子网中，无法与主机通信。

### WSL的防火墙设置

由于Windows对所有入站流量都默认阻止，因此如果需要从外部ssh到WSL，是需要设置防火墙的。

根据微软的官方教程[Hyper-V防火墙](https://learn.microsoft.com/zh-cn/windows/security/operating-system-security/network-security/windows-firewall/hyper-v-firewall){: target="_blank"}，WSL受到Hyper-V防火墙管理，同时，Windows控制面板的防火墙也会自动镜像到WSL上。因此，有两个方法：

<ol>
 
<strong><li>直接使用Windows防火墙，添加入站规则（可视化，更直观）</li></strong>
<ol>
<li>打开控制面板：<code class="language-plaintext highlighter-rouge">win</code>+<code class="language-plaintext highlighter-rouge">r</code>，输入<code class="language-plaintext highlighter-rouge">control</code></li>
<li>选择系统和安全->Windows Defender 防火墙->左侧边栏的高级设置
<p><a href="/myblogs/assets/img/wsl-ssh/windows_firewall.png" class="popup img-link"><img src="assets/img/wsl-ssh/windows_firewall.png" alt="alt text" loading="lazy"></a>
<em>打开的防火墙页面</em></p>
</li>

<li>
选择入站规则，右侧边栏新建规则。随后如图所示设置规则：
<p><a href="/myblogs/assets/img/wsl-ssh/firewall_newrule.png" class="popup img-link"><img src="assets/img/wsl-ssh/firewall_newrule.png" alt="alt text" loading="lazy"></a>
<em>新建规则</em></p>

<p><a href="/myblogs/assets/img/wsl-ssh/firewall_setport.png" class="popup img-link"><img src="assets/img/wsl-ssh/firewall_setport.png" alt="alt text" loading="lazy"></a>
<em>设置端口，注意选择你ssh-server的端口（默认是22）</em></p>

接下来全部下一页即可，最后可以给你的规则取个名字。
<blockquote class="prompt-warning">
  <p>为了安全考虑，请在不需要时禁用此规则。选中该规则，右侧边栏点击禁用即可。</p>
</blockquote>
</li>
</ol>

<strong><li>使用powershell操作Hyper-V防火墙（更推荐）</li></strong>


</ol>
尽管这么操作没有可视化界面，但是却可以只影响WSL，并且开发WSL所有端口后，无论是ROS2的多机还是其他网络应用，都变得更容易。当你熟悉了命令之后，开关也变得简单。
<blockquote class="prompt-warning">
  <p>注意：该方法仅对Windows11 22h2或更新版本有效</p>
</blockquote>

在powershell管理员中运行如下命令（不要修改里面任何字符-Name后的字符串是WSL在Hyper-V中的ID）  

关闭WSL防火墙（允许所有入站请求）：  

```powershell
Set-NetFirewallHyperVVMSetting -Name '{40E0AC32-46A5-438A-A0B2-2B479E8F2E90}' -DefaultInboundAction Allow
```

开启WSL防火墙（拒绝所有入站请求）：  

```powershell
Set-NetFirewallHyperVVMSetting -Name '{40E0AC32-46A5-438A-A0B2-2B479E8F2E90}' -DefaultInboundAction Block
```

<blockquote class="prompt-warning">
  <p>如果你的WSL或docker容器启用了ufw防火墙，该防火墙也需要允许相应端口入站。</p>
</blockquote>

## ssh到WSL

在防火墙设置完成后，就可以直接从局域网连接到WSL了。

## ssh到docker

docker容器也是一样的，在使用`--net host`参数启动后，就可以直接从局域网连接到docker容器了。