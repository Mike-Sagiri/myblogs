---
layout: post
title: ros2使用conda环境运行多个节点
date: 2025-11-07 16:16 +0800
categories: [技术经验, ros2开发]
tags: [ros2, conda] # TAG 名称应始终为小写
mermaid: true
---

由于ros2默认的系统python环境很容易冲突，而conda作为最常用的python环境管理器，又很容易与ros2冲突。因此，本文会以ros2 humble版本为例，详细讲解如何使用不同的conda环境来运行不同的ros2节点。

## 前置说明
每个ros2版本，除了对应一个Ubuntu版本外，还会对应一个python版本。这个python版本是无法更改的。因此，即使使用了其他conda环境来运行节点，该环境中的python版本也必须是ros2对应的python版本，否则将无法运行。比如，<font color="red"><strong>ros2 humble</strong></font>对应<font color="red"><strong>python3.10</strong></font>，因此用来运行ros2节点的conda环境里，也必须是python3.10。

## 多个节点运行在不同的conda环境

### conda设置
首先，安装miniconda，不要使用anaconda，anaconda与ros2的冲突复杂且难以解决。  
安装完成后，运行`conda config --set auto_activate_base false`（旧版本conda）或`conda config --set auto_activate false`（新版本conda），禁止conda在开启终端后自动激活`base`环境。

### conda环境设置
如果我希望*节点yestorch*运行在*ros2_torch*环境，*节点notorch*运行在*ros2_1*环境，需要进行如下操作。
1. 创建环境：`conda create -n ros2_torch python=3.10` 其他环境同上，注意python版本。
2. 在每个conda环境内安装必要包：
```shell
conda activate ros2_torch
python -m pip install rospkg
python -m pip install -U colcon-common-extensions
```
3. 在环境内编译你的ros2节点

```shell
conda activate ros2_torch
python -m colcon build --packages-select yestorch --symlink-install

# 另一个终端
conda activate ros2_1
python -m colcon build --packages-select notorch --symlink-install
```

4. 运行你的ros2节点。此时无所谓什么环境，但是记得`source install/setup.bash`

## 常见问题

### GLIBCXX not found
```shell
miniconda3/envs/ros2_torch/bin/../lib/libstdc++.so.6: version `GLIBCXX_3.4.30' not found
```
如上所示，这是因为系统的libstdc++.so.6更新一些，会包含GLIBCXX_3.4.30，但是conda环境里的老一些，就没有。  
两种解决办法：
1. 在~/.bashrc里加上：`export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6:$LD_PRELOAD`，这样就会优先使用系统的链接库。
2. 更新conda环境内的版本：`conda install -c conda-forge libstdcxx-ng libgcc-ng`

### AttributeError: module 'torch' has no attribute 'cuda'
这是我的一个蠢问题。因为我把一个包名写成了torch，所以`source install/setup.bash`之后，就会把`build/torch`写在`PYTHONPATH`环境变量前面，导致我的包盖过了真正的pytorch包。